<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Equalizer for Virtual Microphone</title>
    <style>
        .slider {
            width: 300px;
        }
    </style>
</head>
<body>
    <h1>Spotify Virtual Input with Equalizer</h1>
    
    <!-- Sliders for EQ -->
    <div>
        <label for="bass">Bass (60 Hz): </label>
        <input type="range" id="bass" class="slider" min="-30" max="30" value="0">
        <span id="bassValue">0</span> dB
    </div>

    <div>
        <label for="treble">Treble (10 kHz): </label>
        <input type="range" id="treble" class="slider" min="-30" max="30" value="0">
        <span id="trebleValue">0</span> dB
    </div>

    <button id="startBtn">Start</button>
    <button id="stopBtn" disabled>Stop</button>
    <p id="status">Click "Start" to play your virtual input audio with the equalizer in real-time.</p>

    <script>
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const status = document.getElementById('status');

        // Equalizer sliders and value spans
        const bassSlider = document.getElementById('bass');
        const trebleSlider = document.getElementById('treble');
        const bassValue = document.getElementById('bassValue');
        const trebleValue = document.getElementById('trebleValue');

        let audioContext;
        let micInput;
        let stream;
        let bassFilter, trebleFilter, gainNode;

        // Update displayed values for sliders
        bassSlider.oninput = () => {
            bassValue.textContent = bassSlider.value;
            if (bassFilter) bassFilter.gain.value = bassSlider.value;
        };

        trebleSlider.oninput = () => {
            trebleValue.textContent = trebleSlider.value;
            if (trebleFilter) trebleFilter.gain.value = trebleSlider.value;
        };

        startBtn.addEventListener('click', async () => {
            try {
                // Request microphone (virtual input in this case) access
                stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                // Create an audio context with increased buffer size and matching sample rate
                audioContext = new (window.AudioContext || window.webkitAudioContext)({
                    latencyHint: 'playback', // Use 'playback' for more buffer and smoother output
                    sampleRate: 44100 // Match standard sample rate for audio (44.1kHz)
                });

                // Create a media stream source from the virtual microphone input
                micInput = audioContext.createMediaStreamSource(stream);

                // Create BiquadFilterNodes for bass and treble with lower Q for smoother adjustments
                bassFilter = audioContext.createBiquadFilter();
                bassFilter.type = "lowshelf";
                bassFilter.frequency.value = 60;  // Bass (60 Hz)
                bassFilter.gain.value = bassSlider.value;
                bassFilter.Q.value = 0.5; // Smoother transition

                trebleFilter = audioContext.createBiquadFilter();
                trebleFilter.type = "highshelf";
                trebleFilter.frequency.value = 10000;  // Treble (10 kHz)
                trebleFilter.gain.value = trebleSlider.value;
                trebleFilter.Q.value = 0.5; // Smoother transition

                // Create a GainNode to control output level and prevent clipping
                gainNode = audioContext.createGain();
                gainNode.gain.value = 0.8; // Adjust to prevent clipping (80% volume)

                // Connect the nodes in series: mic -> bass -> treble -> gain -> output
                micInput
                    .connect(bassFilter)
                    .connect(trebleFilter)
                    .connect(gainNode)
                    .connect(audioContext.destination);

                status.textContent = "Virtual input is playing with the equalizer in real-time.";
                startBtn.disabled = true;
                stopBtn.disabled = false;
            } catch (err) {
                console.error('Error accessing virtual microphone:', err);
                status.textContent = "Error accessing the virtual microphone.";
            }
        });

        stopBtn.addEventListener('click', () => {
            // Stop virtual microphone playback
            if (micInput) {
                micInput.disconnect();
                audioContext.close();
                stream.getTracks().forEach(track => track.stop()); // Stop all media tracks
            }

            status.textContent = "Playback stopped.";
            startBtn.disabled = false;
            stopBtn.disabled = true;
        });
    </script>
</body>
</html>
